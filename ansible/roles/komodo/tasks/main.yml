---
- name: Create Komodo installation directory
  ansible.builtin.file:
    path: "{{ komodo_install_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    mode: "0755"

- name: Generate Komodo Docker Compose file from template
  ansible.builtin.template:
    src: komodo-compose.yml.j2
    dest: "{{ komodo_install_dir }}/compose.yml"
    mode: "0644"
  notify: Restart komodo

- name: Generate Komodo environment configuration from template
  ansible.builtin.template:
    src: compose.env.j2
    dest: "{{ komodo_install_dir }}/compose.env"
    mode: "0644"
    backup: true
  notify: Restart komodo

- name: Deploy Komodo with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "{{ komodo_install_dir }}"
    project_name: "komodo-core"
    env_files:
      - "{{ komodo_install_dir }}/compose.env"
    state: present
    recreate: auto

- name: Wait for MongoDB to be ready
  ansible.builtin.wait_for:
    port: "{{ mongo_port }}"
    host: "localhost"
    delay: 10
    timeout: 300
  ignore_errors: true
  register: komodo_mongo_wait_result

- name: Fail if MongoDB is not ready
  ansible.builtin.fail:
    msg: "MongoDB failed to start. Check Docker Compose logs and environment variables."
  when: komodo_mongo_wait_result is failed

- name: Wait for Komodo Core to be healthy
  ansible.builtin.uri:
    url: "http://localhost:{{ komodo_port }}"
    method: GET
  retries: 30
  delay: 10
  register: komodo_health
  until: komodo_health.status == 200
  ignore_errors: true

- name: Fail if Komodo Core is not healthy
  ansible.builtin.fail:
    msg: "Komodo Core failed to start. Check Docker Compose logs and environment variables."
  when: komodo_health is failed

- name: Display Komodo deployment information
  ansible.builtin.debug:
    msg:
      - "ðŸ¦Ž Komodo Core deployed successfully!"
      - "Web UI: http://{{ ansible_host }}:{{ komodo_port }}"
      - "Database: MongoDB running on port {{ mongo_port }}"
      - ""
      - "ðŸ“‹ Configuration:"
      - "Generated config: {{ komodo_install_dir }}/compose.env"
      - "Docker Compose: {{ komodo_install_dir }}/compose.yml"
      - ""
      - "ðŸ”‘ MANUAL STEP REQUIRED for komodo-op:"
      - "See docs/komodo-op-setup.md for detailed instructions"
      - ""
      - "Quick summary:"
      - "1. Access the Komodo UI and log in via OIDC"
      - "2. Create an API key for komodo-op with secret permissions"
      - "3. Store the API key in 1Password as komodo_op_api_key"
      - "4. Update .env.1password and deploy komodo-op services"
