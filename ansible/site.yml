---
# Komodo Infrastructure Master Playbook
# This playbook orchestrates the complete deployment of Komodo infrastructure
# Run with: ansible-playbook -i inventory/all.yml site.yml

- name: Install Docker on all nodes
  import_playbook: playbooks/01_docker.yml
  tags: [docker, bootstrap]

- name: Deploy Komodo Core
  import_playbook: playbooks/02_komodo_core.yml
  tags: [core]

- name: Initialize Komodo Authentication
  import_playbook: playbooks/03_komodo_auth.yml
  tags: [auth]

- name: Deploy Komodo Periphery
  import_playbook: playbooks/04_komodo_periphery.yml
  tags: [periphery]

- name: Bootstrap komodo-op Variables
  import_playbook: playbooks/05_bootstrap_komodo_op.yml
  when: enable_komodo_op | default(false) | bool
  tags: [komodo-op, secrets]

- name: Deploy komodo-op Stack
  import_playbook: playbooks/06_deploy_komodo_op.yml
  when: enable_komodo_op | default(false) | bool
  tags: [komodo-op, secrets]

- name: Display deployment summary
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Show deployment completion message (without komodo-op)
      ansible.builtin.debug:
        msg:
          - "ğŸ‰ Komodo Infrastructure Deployment Complete!"
          - ""
          - "ğŸ–¥ï¸  Komodo Core: http://{{ hostvars[groups['core'][0]]['ansible_host'] }}:{{ komodo_port }}"
          - "ğŸ”— Periphery nodes: {{ groups['periphery'] | length }} deployed"
          - ""
          - "âœ… All services are running and ready for deployments!"
          - "   Log into the Komodo UI to start managing your infrastructure."
          - ""
          - "ğŸ’¡ Optional: Run 'make deploy-with-op' to enable secret management with komodo-op"
      when: not (enable_komodo_op | default(false) | bool)

    - name: Show deployment completion message (with komodo-op)
      ansible.builtin.debug:
        msg:
          - "ğŸ‰ Komodo Infrastructure Deployment Complete!"
          - ""
          - "ğŸ–¥ï¸  Komodo Core: http://{{ hostvars[groups['core'][0]]['ansible_host'] }}:{{ komodo_port }}"
          - "ğŸ”— Periphery nodes: {{ groups['periphery'] | length }} deployed"
          - "ğŸ” komodo-op: Secret management enabled with 1Password Connect"
          - ""
          - "âœ… All services are running and ready for deployments!"
          - "   Log into the Komodo UI to start managing your infrastructure."
          - ""
          - "ğŸš€ Next steps:"
          - "   1. Verify secrets are syncing from 1Password"
          - "   2. Run 'make app-syncs' to setup application deployments"
      when: enable_komodo_op | default(false) | bool
