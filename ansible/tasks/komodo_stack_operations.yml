---
# Komodo Stack Management Operations
# Common tasks for managing Komodo stacks via API

- name: List all Komodo stacks
  ansible.builtin.uri:
    url: "{{ komodo_base_url }}/read"
    method: POST
    headers:
      X-Api-Key: "{{ komodo_api_key }}"
      X-Api-Secret: "{{ komodo_api_secret }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "ListStacks"
      params: {}
    status_code: 200
  register: stacks_list
  tags: [api, stacks, list]

- name: Find stack by name pattern
  ansible.builtin.set_fact:
    found_stack: "{{ stacks_list.json | selectattr('name', 'match', stack_name_pattern) | first | default(none) }}"
  when:
    - stack_name_pattern is defined
    - stacks_list is defined
  tags: [api, stacks, find]

- name: Get specific stack details
  ansible.builtin.uri:
    url: "{{ komodo_base_url }}/read"
    method: POST
    headers:
      X-Api-Key: "{{ komodo_api_key }}"
      X-Api-Secret: "{{ komodo_api_secret }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "GetStack"
      params:
        stack: "{{ stack_id }}"
    status_code: 200
  register: stack_details
  when: stack_id is defined
  tags: [api, stacks, details]

- name: Wait for stack to appear by name pattern
  ansible.builtin.uri:
    url: "{{ komodo_base_url }}/read"
    method: POST
    headers:
      X-Api-Key: "{{ komodo_api_key }}"
      X-Api-Secret: "{{ komodo_api_secret }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "ListStacks"
      params: {}
    status_code: 200
  register: stacks_list_wait
  until: stacks_list_wait.json | selectattr('name', 'match', stack_name_pattern) | list | length > 0
  retries: "{{ stack_appear_retries | default(30) }}"
  delay: "{{ stack_appear_delay | default(10) }}"
  when:
    - stack_name_pattern is defined
    - wait_for_stack_appear | default(false) | bool
  tags: [api, stacks, wait_appear]

- name: Set found stack from wait result
  ansible.builtin.set_fact:
    found_stack: "{{ stacks_list_wait.json | selectattr('name', 'match', stack_name_pattern) | first }}"
  when:
    - stack_name_pattern is defined
    - stacks_list_wait is defined
    - wait_for_stack_appear | default(false) | bool
  tags: [api, stacks, set_found]

- name: Wait for stack services to be running
  ansible.builtin.uri:
    url: "{{ komodo_base_url }}/read"
    method: POST
    headers:
      X-Api-Key: "{{ komodo_api_key }}"
      X-Api-Secret: "{{ komodo_api_secret }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "ListStacks"
      params:
        stack: "{{ found_stack | default(stack_name) }}"
    status_code: 200
  register: stack_services
  until: stack_services.json[0].info.state is defined and stack_services.json[0].info.state == "running"
  retries: "{{ stack_running_retries | default(60) }}"
  delay: "{{ stack_running_delay | default(10) }}"
  when:
    - (found_stack is defined) or (stack_name is defined)
    - wait_for_running | default(false) | bool
  tags: [api, stacks, wait_running]


- name: Check if stack exists by name pattern
  ansible.builtin.set_fact:
    stack_exists: "{{ (stacks_list.json | selectattr('name', 'match', stack_name_pattern) | list | length) > 0 }}"
  when:
    - stack_name_pattern is defined
    - stacks_list is defined
  tags: [api, stacks, exists]
