---
# Bootstrap Komodo Global Variables for komodo-op Initial Deployment
# This playbook creates the required variables in Komodo that komodo-op needs to start

- name: Bootstrap Komodo Variables for komodo-op
  hosts: localhost
  gather_facts: false
  vars:
    komodo_port: "{{ hostvars[groups['core'][0]]['komodo_port'] }}"
    komodo_base_url: "http://{{ hostvars[groups['core'][0]]['ansible_host'] }}:{{ komodo_port }}"
    komodo_api_key: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_key', vault='Homelab Ansible') }}"
    komodo_api_secret: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_secret', vault='Homelab Ansible') }}"

  tasks:
    - name: Check Komodo Core health
      ansible.builtin.include_tasks: ../tasks/komodo_health_check.yml

    - name: Check if GitHub account exists in Komodo
      ansible.builtin.uri:
        url: "{{ komodo_base_url }}/read"
        method: POST
        headers:
          X-Api-Key: "{{ komodo_api_key }}"
          X-Api-Secret: "{{ komodo_api_secret }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "ListGitProviderAccounts"
          params: {}
        status_code: [200]
      register: github_accounts_list
      tags: [github]

    - name: Create GitHub account in Komodo
      ansible.builtin.uri:
        url: "{{ komodo_base_url }}/write"
        method: POST
        headers:
          X-Api-Key: "{{ komodo_api_key }}"
          X-Api-Secret: "{{ komodo_api_secret }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "CreateGitProviderAccount"
          params:
            account:
              provider: "github.com"
              username: "{{ lookup('community.general.onepassword', 'Komodo Github Provider Account', field='username', vault='Homelab Ansible') }}"
              token: "{{ lookup('community.general.onepassword', 'Komodo Github Provider Account', field='token', vault='Homelab Ansible') }}"
        status_code: [200, 201]
      register: github_account_result
      when: >
        github_accounts_list.json |
        selectattr('domain', 'equalto', 'github.com') |
        selectattr('username', 'equalto', 
          lookup('community.general.onepassword', 'Komodo Github Provider Account', field='username', vault='Homelab Ansible')) |
        list | length == 0
      tags: [github]

    - name: Display GitHub account status
      ansible.builtin.debug:
        msg: "GitHub account {{ 'created' if github_account_result is not skipped else 'already exists' }}"
      tags: [github]

    - name: Create komodo-op global variables
      ansible.builtin.include_tasks: ../tasks/komodo_variable_operations.yml
      vars:
        variables_list:
          - name: "KOMODO_API_KEY"
            value: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_key', vault='Homelab Ansible') }}"
            description: "API key for komodo-op to authenticate with Komodo Core"
            is_secret: true
          - name: "KOMODO_API_SECRET"
            value: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_secret', vault='Homelab Ansible') }}"
            description: "API secret for komodo-op to authenticate with Komodo Core"
            is_secret: true
          - name: "OP_VAULT_UUID"
            value: "{{ lookup('community.general.onepassword', 'Komodo Homelab Credentials File', field='op_vault_uuid', vault='Homelab Ansible') }}"
            description: "1Password vault UUID for komodo-op to sync from"
            is_secret: false
          - name: "OP_SERVICE_ACCOUNT_TOKEN"
            value: "{{ lookup('community.general.onepassword', 'Komodo Homelab Access Token: Komodo Homelab Stacks', field='credential', vault='Homelab Ansible') }}"
            description: "1Password Connect service account token for komodo-op"
            is_secret: true
          - name: "OP_CREDENTIALS_BASE64"
            value: "{{ lookup('community.general.onepassword_doc', 'Komodo Homelab Credentials File', vault='Homelab Ansible') | b64encode | replace('\n', '') }}"
            description: "Base64-encoded 1Password Connect credentials file for komodo-op"
            is_secret: true

    - name: Display bootstrap results
      ansible.builtin.debug:
        msg: |-
          üîê Komodo Variables Bootstrap Complete!

          Variables Created/Verified:
          {% if variables_results is defined and variables_results.results is defined %}
          {% for result in variables_results.results %}
          - {{ result.item.name }}: {{ 'Created' if result.status in [200, 201] else 'Already exists' }}
          {% endfor %}
          {% else %}
          - Variables processed (check mode or task was skipped)
          {% endif %}

          ‚úÖ komodo-op is now ready to be deployed

          Note: These variables only need to be created once.
          After komodo-op is deployed, it will manage additional secrets automatically.
