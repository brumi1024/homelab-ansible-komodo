---
# Bootstrap Komodo Global Variables for komodo-op Initial Deployment
# This playbook creates the required variables in Komodo that komodo-op needs to start

- name: Bootstrap Komodo Variables for komodo-op
  hosts: localhost
  gather_facts: no
  vars:
    komodo_port: "{{ hostvars[groups['core'][0]]['komodo_port'] }}"
    komodo_base_url: "http://{{ hostvars[groups['core'][0]]['ansible_host'] }}:{{ komodo_port }}"
    komodo_api_key: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_key', vault='Homelab') }}"
    komodo_api_secret: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_secret', vault='Homelab') }}"

  tasks:
    - name: Check Komodo Core health
      uri:
        url: "{{ komodo_base_url }}"
        method: GET
        status_code: 200
      retries: 5
      delay: 10

    - name: Bootstrap required Komodo global variables for komodo-op
      uri:
        url: "{{ komodo_base_url }}/write"
        method: POST
        headers:
          X-Api-Key: "{{ komodo_api_key }}"
          X-Api-Secret: "{{ komodo_api_secret }}"
          Content-Type: "application/json"
        body_format: json
        body:
          type: "CreateVariable"
          params:
            name: "{{ item.name }}"
            value: "{{ item.value }}"
            description: "{{ item.description }}"
            is_secret: "{{ item.is_secret | default(false) }}"
        status_code: [200, 201, 409]  # 409 if variable already exists
      loop:
        - name: "KOMODO_API_KEY"
          value: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_key', vault='Homelab') }}"
          description: "API key for komodo-op to authenticate with Komodo Core"
          is_secret: true
        - name: "KOMODO_API_SECRET"
          value: "{{ lookup('community.general.onepassword', 'Komodo', field='komodo_api_secret', vault='Homelab') }}"
          description: "API secret for komodo-op to authenticate with Komodo Core"
          is_secret: true
        - name: "OP_SERVICE_ACCOUNT_TOKEN"
          value: "{{ lookup('community.general.onepassword', 'ConnectServer', field='OP_SERVICE_ACCOUNT_TOKEN', vault='Homelab') }}"
          description: "1Password Connect service account token for komodo-op"
          is_secret: true
        - name: "OP_VAULT_UUID"
          value: "{{ lookup('community.general.onepassword', 'ConnectServer', field='OP_VAULT_UUID', vault='Homelab') }}"
          description: "1Password vault UUID for komodo-op to sync from"
          is_secret: false
      register: bootstrap_results

    - name: Display bootstrap results
      debug:
        msg: |
          Bootstrap Results:
          {% for result in bootstrap_results.results %}
          - {{ result.item.name }}: {{ 'Created' if result.status in [200, 201] else 'Already exists' }}
          {% endfor %}
          
          Next Steps:
          1. Deploy komodo-op stack via Komodo UI or resource sync
          2. Wait for 1Password Connect to start and komodo-op to begin syncing
          3. Check Komodo global variables for new secrets from 1Password
          
          Note: This bootstrap only needs to be run once for initial setup.
          After komodo-op is running, it will manage variables automatically.