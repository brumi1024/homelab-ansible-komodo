---
- name: Manage Komodo Periphery Instances
  hosts: periphery
  become: yes
  gather_facts: yes
  serial: 2  # Deploy 2 nodes at a time to avoid overwhelming the core

  pre_tasks:
    - name: Check if node is bootstrapped
      stat:
        path: /opt/.bootstrap_complete
      register: bootstrap_marker
      
    - name: Fail if node not bootstrapped
      fail:
        msg: "Node not bootstrapped. Run bootstrap.yml first."
      when: not bootstrap_marker.stat.exists
      
    - name: Display action information
      debug:
        msg: 
          - "Action: {{ komodo_action | default('install') }} Komodo Periphery on: {{ inventory_hostname }}"
          - "Site: {{ node_site }}"
          - "Stacks: {{ node_stacks | default([]) | join(', ') }}"

  roles:
    - role: bpbradley.komodo
      vars:
        komodo_action: install
        komodo_version: "{{ komodo_periphery_version | default('latest') }}"
      tags: [komodo-periphery]

  post_tasks:
    - name: Display completion message (install/update)
      debug:
        msg: 
          - "üîó Komodo Periphery {{ komodo_action | default('install') }}ed on {{ inventory_hostname }}"
          - "Stacks: {{ node_stacks | default([]) | join(', ') }}"
          - ""
          - "Periphery is now registered with Komodo Core and ready for deployments!"
      when: komodo_action | default('install') in ['install', 'update']

    - name: Display completion message (uninstall)
      debug:
        msg: 
          - "üóëÔ∏è Komodo Periphery removed from {{ inventory_hostname }}"
          - "The systemd service and configuration have been cleaned up."
      when: komodo_action | default('install') == 'uninstall'